<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="feeslip_tree_view" model="ir.ui.view">
        <field name="name">fee.slip.tree.view</field>
        <field name="model">oe.feeslip</field>
        <field name="arch" type="xml">
            <list string="Feeslips" js_class="hr_payroll_payslip_tree" sample="1" multi_edit="1">
                <field name="currency_id" invisible="1"/>
                <field name="number" decoration-bf="1"/>
                <field name="student_id" />
                <!--
                <field name="payslip_run_id"/>
-->
                <field name="fee_struct_id" optional="hide"/>
                <field name="date_from" optional="hide"/>
                <field name="date_to" optional="hide"/>
                <field name="company_id" invisible="1"/>
                <field name="company_id" groups="base.group_multi_company" options="{'no_create': True}"/>
                <field name="basic_wage" widget="monetary" options="{'currency_field': 'currency_id'}" optional="show"/>
                <field name="net_wage" widget="monetary" options="{'currency_field': 'currency_id'}" decoration-bf="1" optional="show"/>
                <field name="state" widget="badge" decoration-info="state == 'draft'" decoration-warning="state == 'verify'" decoration-success="state in ('done','paid')"/>
            </list>
        </field>
    </record>

    <record id="feeslip_kanban_view" model="ir.ui.view">
        <field name="name">fee.slip.kanban.view</field>
        <field name="model">oe.feeslip</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" sample="1">
                <field name="currency_id"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_content oe_kanban_global_click">
                            <div class="row">
                                <div class="col-6">
                                    <strong><field name="student_id"/></strong>
                                </div>
                                <div class="col-6">
                                    <span class="float-right badge badge-secondary">
                                        <field name="state"/>
                                    </span>
                                </div>
                                <div class="col-12">
                                    <span>
                                        <field name="date_from"/> - <field name="date_to"/>
                                    </span>
                                </div>
                                <div class="col-12">
                                    <span><field name="name"/></span>
                                </div>
                                <div class="col-12">
                                    <span>Net - <field name="net_wage"/></span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="feeslip_form_view" model="ir.ui.view">
        <field name="name">fee.slip.form.voew</field>
        <field name="model">oe.feeslip</field>
        <field name="arch" type="xml">
            <form string="Feeslip">
            <header>
                <button string="Confirm" name="action_payslip_done" type="object" states="verify" class="oe_highlight" context="{'payslip_generate_pdf': True}"/>
                <button string="Mark as paid" name="action_payslip_paid" type="object" states="done" class="oe_highlight"/>
                <button string="Refund" name="refund_sheet" type='object' attrs="{'invisible': ['|', '|', ('has_refund_slip', '=', True), ('credit_note', '=', True), ('state', 'not in', ('done', 'paid'))]}"/>
                <button string="Refund" name="refund_sheet" type='object' attrs="{'invisible': ['|', '|', ('has_refund_slip', '=', False), ('credit_note', '=', True), ('state', 'not in', ('done', 'paid'))]}"
                    confirm="Another refund payslip with the same amount has been found. Do you want to create a new one ?"/>
                <button string="Set to Draft" name="action_payslip_draft" type="object" states="cancel"/>
                <button string="Compute Sheet" name="compute_sheet" type="object" attrs="{'invisible': ['|', ('state', '!=', 'draft'), ('credit_note', '=', True)]}" class="oe_highlight" help="Recompute the payslip lines only, not the worked days / input lines"/>
                <button string="Compute Sheet" name="compute_sheet" type="object" attrs="{'invisible': ['|', ('state', '!=', 'verify'), ('credit_note', '=', True)]}" help="Recompute the payslip lines only, not the worked days / input lines"/>
                <button string="Cancel" name="action_payslip_cancel" type="object" states="draft,done,verify"/>
                <button string="Print" name="action_print_payslip" type="object"/>
                <button string="Export Payslip" name="action_export_payslip" type="object" attrs="{'invisible': [('is_superuser', '=', False)]}"/>
                <field name="state" widget="statusbar" statusbar_visible="draft,done,paid"/>
            </header>
            <sheet>
                <div class="oe_button_box" name="button_box">
                    <button type="object" class="oe_stat_button" id="open_work_entries"
                        icon="fa-calendar" name="action_open_work_entries" string="Work Entries">
                    </button>
                    <!--
                    <button type="object" class="oe_stat_button" name="action_open_salary_attachments" id="open_salary_attachments"
                        icon="fa-files-o" attrs="{'invisible': [('salary_attachment_count', '=', 0)]}">
                        <field name="salary_attachment_count" widget="statinfo" string="Salary Attachments"/>
                    </button>
-->
                </div>
                <div class="oe_title" name="title">
                    <h1><field name="student_id" placeholder="Student"/></h1>
                    <h2><field name="number" attrs="{'invisible': [('state', '=', 'draft')]}"/></h2>
                </div>
                 <div class="alert alert-warning" role="alert" attrs="{'invisible': [('warning_message','=',False)]}">
                    <field name="warning_message"/>
                </div>
                <group>
                    <group>
                        <label for="date_from" string="Period"/>
                        <div>
                            <field name="date_from" class="oe_inline"/> - <field name="date_to" class="oe_inline"/>
                        </div>
                        <field name="country_id" invisible="1"/>
                        <field name="country_code" invisible="1"/>
                    </group>
                    <group>
                    <!--
                        <field name="payslip_run_id" string="Batch"/>
-->
                        <field name="fee_struct_id" required="1"/>
                    <!--
                    <field name="salary_attachment_ids" invisible="1" force_save="1"/>
-->
                        <field name="sum_worked_hours" invisible="1"/>
                        <field name="normal_wage" invisible="1"/>
                        <field name="credit_note" invisible="1"/>
                        <field name="is_superuser" invisible="1"/>
                        <field name="has_refund_slip" invisible="1"/>
                    </group>
                </group>
                <notebook>
                    <page string="Worked Days &amp; Inputs" name="worked_days_input">
                        <separator string="Worked Days"/>
                        <separator string="Other Fee Inputs"/>
                        <field name="input_line_ids" colspan="4" nolabel="1">
                            <list string="Input Data" editable="bottom">
                                <!--
                                    Required 0 to force client to send on change request even when not defined
                                    Salary Attachments would otherwise not properly be computed and payslip_id is
                                    required for _allowed_input_type_ids to work..
                                -->
                                <field name="feeslip_id" invisible="1" required="0"/>
                                <field name="_allowed_input_type_ids" invisible="1"/>
                                <field name="input_type_id"/>
                                <field name="name"/>
                                <field name="amount"/>
                                <field name="sequence" invisible="True"/>
                            </list>
                            <form string="Payslip Line">
                                <group col="4">
                                    <field name="feeslip_id" invisible="1"/>
                                    <field name="_allowed_input_type_ids" invisible="1"/>
                                    <field name="input_type_id"/>
                                    <field name="name"/>
                                    <field name="sequence"/>
                                    <field name="amount"/>
                                </group>
                            </form>
                        </field>
                    </page>
                    <page string="Fee Computation" name="fee_computation">
                        <field name="line_ids" colspan="4" nolabel="1">
                            <list string="Fee Structure" editable="bottom" decoration-info="total == 0" create="0" delete="0">
                                <field name="name"/>
                                <field name="code" readonly="1" force_save="1" optional="hide"/>
                                <field name="category_id" readonly="1" force_save="1"/>
                                <field name="sequence" invisible="1" readonly="1" force_save="1"/>
                                <field name="quantity" readonly="1" force_save="1"/>
                                <field name="rate" readonly="1" force_save="1"/>
                                <field name="fee_rule_id" groups="base.group_no_one" readonly="1" force_save="1"/>
                                <field name="amount" readonly="1" force_save="1"/>
                                <field name="total" readonly="1" force_save="1"/>
                                <field name="currency_id" invisible="1"/>
                            </list>
                            <form string="Feeslip Line">
                                <group col="4">
                                    <field name="name"/>
                                    <field name="code"/>
                                    <field name="category_id"/>
                                    <field name="sequence"/>
                                    <field name="quantity"/>
                                    <field name="rate"/>
                                    <field name="amount"/>
                                    <field name="total"/>
                                    <field name="fee_rule_id"/>
                                    <field name="currency_id" invisible="1"/>
                                </group>
                            </form>
                        </field>
                    </page>
                    <page string="Other Info" name="account_info">
                        <group>
                            <group>
                                <field name="name"/>
                                <field name="company_id" invisible="1"/>
                                <field name="company_id" groups="base.group_multi_company" options="{'no_create': True}"/>
                            </group>
                            <group name="accounting">
                                <field name="has_negative_net_to_report"/>
                                <field name="negative_net_to_report_display" invisible="1"/>
                                <field name="paid"/>
                            </group>
                        </group>
                        <div colspan="4">
                            <field name="note" placeholder="Add an internal note..."/>
                        </div>
                    </page>
                </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <record id="feeslip_filter_view" model="ir.ui.view">
        <field name="name">fee.slip.select</field>
        <field name="model">oe.feeslip</field>
        <field name="arch" type="xml">
            <search string="Search Feeslips">
                <field name="student_id"/>
                <field name="name" string="Feeslips" filter_domain="['|', ('name', 'ilike', self), ('number', 'ilike', self)]"/>
                <field name="date_from"/>
                <!--
                <field name="payslip_run_id"/>
-->
                <filter string="To Compute" name="draft" domain="[('state', '=', 'draft')]" help="Draft Slip"/>
                <filter string="To Confirm" name="draft" domain="[('state', '=', 'verify')]" help="Slips to Confirm"/>
                <filter string="Done" name="done" domain="[('state', '=', 'done')]" help="Done Slip"/>
                <separator/>
                <filter string="Date" name="date_filter" date="date_to" default_period="last_month"/>
                <separator/>
                <filter string="Credit Notes" name="credit_note" domain="[('credit_note', '=', True)]"/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter string="Student" name="student_id" context="{'group_by': 'student_id'}"/>
                    <filter string="Status" name="state" context="{'group_by': 'state'}"/>
                    <!--
                    <filter string="Batch" name="group_by_batch" context="{'group_by': 'payslip_run_id'}"/>
-->
                    <filter string="Company" name="company_id" groups="base.group_multi_company" context="{'group_by': 'company_id'}"/>
                </group>
            </search>
        </field>
    </record>
    <record id="action_feeslip_to_collect" model="ir.actions.act_window">
        <field name="name">Feeslips To Collect</field>
        <field name="res_model">oe.feeslip</field>
        <field name="view_mode">list,kanban,form,pivot,activity</field>
        <field name="search_view_id" ref="feeslip_filter_view"/>
        <field name="domain">[('state', 'in', ['draft', 'verify'])]</field>
    </record>
    <record id="action_feeslip" model="ir.actions.act_window">
        <field name="name">Student Feeslips</field>
        <field name="res_model">oe.feeslip</field>
        <field name="view_mode">list,kanban,form,pivot</field>
        <field name="search_view_id" ref="feeslip_filter_view"/>
        <field name="context">{'search_default_group_by_batch': 1}</field>
    </record>
    <record id="action_feeslip_month_form" model="ir.actions.act_window">
        <field name="name">Student Feeslips</field>
        <field name="res_model">oe.feeslip</field>
        <field name="view_mode">list,kanban,form,activity</field>
        <field name="search_view_id" ref="feeslip_filter_view"/>
        <field name="context">{"search_default_group_by_batch":1}</field>
    </record>

    <record id="act_student_feeslip_list" model="ir.actions.act_window">
        <field name="res_model">oe.feeslip</field>
        <field name="name">Feeslips</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'search_default_student_id': [active_id], 'default_student_id': active_id}</field>
    </record>

    <menuitem
        id="menu_feeslips_to_collect"
        name="To Collect"
        parent="menu_school_fees_main"
        sequence="10"
        action="action_feeslip_to_collect"
        groups="account.group_account_invoice"/>
    
    <menuitem
        id="menu_feeslips_month_form"
        name="All Feeslips"
        parent="menu_school_fees_main"
        sequence="20"
        action="action_feeslip_month_form"
        groups="account.group_account_invoice"/>

</odoo>
